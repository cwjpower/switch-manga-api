name: Deploy Switch Manga API to Oracle Cloud

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸš€ Deploy to Oracle Cloud
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ${{ secrets.ORACLE_USER }}
        key: ${{ secrets.ORACLE_SSH_KEY }}
        script: |
          echo "============================================"
          echo "ğŸš€ Starting Switch Manga API Deployment"
          echo "============================================"
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ubuntu/switch-manga-api
          
          # í˜„ì¬ ìƒíƒœ í™•ì¸
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‚ Current branch: $(git branch --show-current)"
          
          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          echo "ğŸ“¥ Pulling latest code from GitHub..."
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master
          
          # Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          echo "ğŸ”§ Setting permissions..."
          chmod +x ./gradlew
          
          # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          echo "â¹ï¸  Stopping old process..."
          if [ -f ~/api.pid ]; then
            PID=$(cat ~/api.pid)
            echo "Found PID: $PID"
            kill $PID 2>/dev/null || echo "Process already stopped"
            rm ~/api.pid
          else
            echo "No PID file found, process might not be running"
          fi
          sleep 3
          
          # ë¹Œë“œ
          echo "ğŸ”¨ Building project..."
          ./gradlew clean build -x test
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo "ğŸ“¦ Checking build output..."
          ls -lh build/libs/
          
          JAR_FILE=$(find build/libs -name "*.jar" -type f | head -1)
          
          if [ -n "$JAR_FILE" ]; then
            echo "âœ… Build successful! Found: $JAR_FILE"
          else
            echo "âŒ Build failed! No JAR file found."
            exit 1
          fi
          
          # ìƒˆ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
          echo "â–¶ï¸  Starting new process..."
          nohup java -jar $JAR_FILE > ~/api.log 2>&1 &
          echo $! > ~/api.pid
          echo "Process started with PID: $(cat ~/api.pid)"
          
          # ë˜ëŠ” Gradleë¡œ ì‹¤í–‰:
          # nohup ./gradlew bootRun > ~/api.log 2>&1 &
          
          echo "â³ Waiting for API to start..."
          sleep 10
          
          # API ìƒíƒœ í™•ì¸
          echo "ğŸ” Checking API status..."
          if curl -f http://localhost:8081/api/v1/publishers > /dev/null 2>&1; then
            echo "âœ… API is running successfully!"
          else
            echo "âš ï¸  API might not be ready yet. Check logs: tail -f ~/api.log"
          fi
          
          echo "============================================"
          echo "âœ… Deployment completed!"
          echo "ğŸŒ API URL: http://152.67.199.56:8081/api/v1"
          echo "ğŸ“‹ Logs: tail -f ~/api.log"
          echo "============================================"
