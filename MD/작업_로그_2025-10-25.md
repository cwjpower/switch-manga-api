# Switch Manga API 개발 작업 로그
작업 기간: 2025-10-25

## 🎯 작업 목표
- Spring Boot API 서버 재시작 및 에러 수정
- Entity 필드 누락 문제 해결
- Spring Security 403 에러 해결

---

## ✅ 완료된 작업

### 1. Entity 필드 추가

#### Volume.java 수정
**파일:** `src/main/java/com/switchmanga/api/entity/Volume.java`

**추가된 필드:**
```java
// 조회수
@Column(name = "view_count", columnDefinition = "BIGINT DEFAULT 0")
private Long viewCount = 0L;

// 평균 평점
@Column(name = "average_rating", columnDefinition = "DECIMAL(3,2) DEFAULT 0.0")
private Double averageRating = 0.0;
```

**이유:** VolumeRepository에서 사용하는 필드가 Entity에 없어서 런타임 에러 발생

---

#### Series.java 수정
**파일:** `src/main/java/com/switchmanga/api/entity/Series.java`

**추가된 필드:**
```java
// 카테고리 ID
@Column(name = "category_id")
private Long categoryId;

// 조회수
@Column(name = "view_count", columnDefinition = "BIGINT DEFAULT 0")
private Long viewCount = 0L;

// 평균 평점
@Column(name = "average_rating", columnDefinition = "DECIMAL(3,2) DEFAULT 0.0")
private Double averageRating = 0.0;

// 리뷰 개수
@Column(name = "review_count", columnDefinition = "INT DEFAULT 0")
private Integer reviewCount = 0;
```

**이유:** SeriesRepository에서 사용하는 필드가 Entity에 없어서 런타임 에러 발생

---

### 2. Repository 메서드 수정

#### VolumeRepository.java 수정
**파일:** `src/main/java/com/switchmanga/api/repository/VolumeRepository.java`

**변경 내용:**
```java
// ❌ 기존 (에러)
@Query("SELECT v FROM Volume v WHERE v.publishDate >= :date ...")
List<Volume> findByPublishDateAfter(@Param("date") java.time.LocalDate date);

// ✅ 수정 (정상)
@Query("SELECT v FROM Volume v WHERE v.publicationDate >= :date ...")
List<Volume> findByPublicationDateAfter(@Param("date") LocalDateTime date);
```

**이유:** 
- Volume Entity의 필드명은 `publicationDate`인데 쿼리에서 `publishDate` 사용
- 타입도 `LocalDate` → `LocalDateTime`으로 변경

---

### 3. JWT 필터 수정

#### JwtAuthenticationFilter.java 수정
**파일:** `src/main/java/com/switchmanga/api/security/JwtAuthenticationFilter.java`

**추가된 코드:**
```java
// 필터를 건너뛸 경로 목록
private static final List<String> EXCLUDED_PATHS = List.of(
    "/api/v1/auth/",
    "/swagger-ui/",
    "/v3/api-docs/",
    "/api/v1/publishers",
    "/api/v1/series",
    "/api/v1/volumes"
);

@Override
protected boolean shouldNotFilter(HttpServletRequest request) {
    String path = request.getRequestURI();
    return EXCLUDED_PATHS.stream().anyMatch(path::startsWith);
}
```

**이유:** Public API들이 JWT 필터를 거치지 않도록 설정

---

### 4. Security 설정 수정

#### SecurityConfig.java 수정
**파일:** `src/main/java/com/switchmanga/api/config/SecurityConfig.java`

**변경 내용:**
```java
// ❌ 기존 (하위 경로만 허용)
.requestMatchers("/api/v1/publishers/**").permitAll()

// ✅ 수정 (정확한 경로와 하위 경로 모두 허용)
.requestMatchers("/api/v1/publishers", "/api/v1/publishers/**").permitAll()
.requestMatchers("/api/v1/series", "/api/v1/series/**").permitAll()
.requestMatchers("/api/v1/volumes", "/api/v1/volumes/**").permitAll()
```

**이유:** `/api/v1/publishers/**`는 `/api/v1/publishers/1`만 매칭되고, `/api/v1/publishers`는 매칭 안 됨

---

### 5. 서버 실행 성공

**결과:**
```bash
Started SwitchMangaApiApplication in 9.598 seconds (process running for 10.397)
```

**환경:**
- GCP 서버: 34.64.84.117
- 포트: 8080
- 프로필: local

**확인된 사항:**
- ✅ 서버 정상 시작
- ✅ Swagger UI 접근 성공 (200 OK)
- ❌ Publishers API 403 에러 (미해결)

---

## 🔥 현재 이슈

### 403 Forbidden 에러

**증상:**
```bash
curl http://localhost:8080/api/v1/publishers
HTTP/1.1 403 Forbidden
```

**확인된 사실:**
1. ✅ Swagger UI는 200 OK → shouldNotFilter 작동 중
2. ✅ SecurityConfig 코드는 정확함
3. ✅ JwtAuthenticationFilter 코드도 정확함
4. ❌ Publishers API만 403 발생

**가능한 원인:**
1. Spring Security 필터 순서 문제
2. RequestMatcher 경로 매칭 실패
3. 다른 Security 설정과 충돌
4. 로그 레벨 낮아서 정확한 원인 파악 불가

---

## 🎯 다음 작업 계획 (2025-10-25 19:00)

### 1단계: 403 에러 해결
```yaml
# application.yml에 로그 추가
logging:
  level:
    org.springframework.security: TRACE
    com.switchmanga.api.security: DEBUG
```

**방법:**
1. 로그 레벨 올리기
2. 정확한 차단 지점 파악
3. SecurityConfig 또는 필터 수정

---

### 2단계: API 테스트
```bash
# Publishers API
curl http://localhost:8080/api/v1/publishers

# Series API
curl http://localhost:8080/api/v1/series

# Volumes API
curl http://localhost:8080/api/v1/volumes
```

---

### 3단계: 샘플 데이터 임포트
```bash
# 파일 위치: /mnt/project/sample_data_manga.sql
mysql -u root -p switch_manga < sample_data_manga.sql
```

---

### 4단계: 샘플 데이터로 API 재테스트
- Publishers 목록 조회 (데이터 있어야 함)
- Series 목록 조회
- Volumes 목록 조회

---

### 5단계: 로그인 시스템 구축
**구현 항목:**
1. POST /api/v1/auth/login
2. POST /api/v1/auth/register
3. JWT 토큰 발급 로직
4. JWT 토큰 검증 로직

---

### 6단계: Publisher Portal 연동
- 로그인 기능 연결
- Dashboard 데이터 연동
- 매출/주문 통계 API 연결

---

## 📁 관련 파일 목록

### Entity
- `/src/main/java/com/switchmanga/api/entity/Volume.java`
- `/src/main/java/com/switchmanga/api/entity/Series.java`

### Repository
- `/src/main/java/com/switchmanga/api/repository/VolumeRepository.java`
- `/src/main/java/com/switchmanga/api/repository/SeriesRepository.java`

### Security
- `/src/main/java/com/switchmanga/api/security/JwtAuthenticationFilter.java`
- `/src/main/java/com/switchmanga/api/config/SecurityConfig.java`

### 설정
- `/src/main/resources/application.yml`

### 샘플 데이터
- `/mnt/project/sample_data_manga.sql`

---

## 🛠 개발 환경

### 서버
- **IP:** 34.64.84.117
- **포트:** 8080
- **OS:** Ubuntu (GCP)
- **DB:** MariaDB 11.8.3

### 로컬
- **IDE:** IntelliJ IDEA
- **OS:** Windows
- **프로젝트 경로:** D:\Again_E-Book\switch-manga-api\switch-manga-api

### 기술 스택
- Spring Boot 3.5.6
- Java 17
- Spring Security 6.5.5
- Hibernate 6.6.29
- MariaDB
- JWT (JSON Web Token)

---

## 💡 학습한 내용

### Git Workflow 최적화
1. ✅ 로컬에서 컴파일 성공 확인
2. ✅ Git push
3. ✅ 서버에서 pull
4. ✅ 서버 재시작

**이유:** 서버에서 직접 수정하면 sync 안 맞음!

---

### Spring Data JPA 검증
- `./gradlew build -x test` → 컴파일만 체크
- 실제 실행 → JPA가 런타임에 Repository 메서드 검증
- **컴파일 성공 ≠ 실행 성공**

---

### Spring Security 6.x
- `OncePerRequestFilter` → 모든 요청에 실행
- `shouldNotFilter()` 오버라이드로 특정 경로 제외
- `requestMatchers()` 경로 매칭 주의!
  - `/api/v1/publishers/**` → 하위 경로만
  - `/api/v1/publishers` → 정확한 경로만

---

## 📝 코드 스니펫

### Clean Build & 재시작
```bash
cd ~/switch-manga-api
pkill -f switch-manga-api
./gradlew clean build -x test
nohup ./gradlew bootRun > server.log 2>&1 &
tail -f server.log
```

---

### API 테스트
```bash
# 상태 코드 포함
curl -w "\nHTTP Status: %{http_code}\n" http://localhost:8080/api/v1/publishers

# 상세 헤더 보기
curl -v http://localhost:8080/api/v1/publishers

# 로컬에서 테스트
curl -i http://localhost:8080/api/v1/publishers
```

---

### Git 명령어
```bash
# 상태 확인
git status

# 컴파일
./gradlew compileJava

# 커밋 & 푸시
git add .
git commit -m "메시지"
git push origin main

# 로그 확인
git log --oneline -5
```

---

## 🎯 중요 포인트

1. **항상 로컬에서 먼저 빌드 테스트!**
2. **컴파일 성공 ≠ 실행 성공 (JPA 검증)**
3. **Security 설정은 로그 보고 디버깅!**
4. **샘플 데이터는 DB에 넣어야 테스트 가능!**
5. **Swagger UI가 되면 shouldNotFilter는 작동 중!**

---

## 📞 다음 세션 시작할 때

**이 문서를 새 대화창에 붙여넣으면:**
- ✅ 지금까지 한 작업 전부 공유됨
- ✅ 현재 이슈 상태 파악됨
- ✅ 다음 할 일 명확함

**또는 이렇게 시작:**
```
"찰리야, 어제 SecurityConfig 403 에러까지 작업했는데,
로그 레벨 올려서 원인 찾고 해결하자!"
```

---

## ⏰ 다음 세션
**일시:** 2025-10-25 19:00
**작업:** SecurityConfig 403 에러 해결

---

*문서 작성: 2025-10-25*
*작성자: Claude (찰리)*
