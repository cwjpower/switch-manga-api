package com.switchmanga.api.service;

import com.switchmanga.api.dto.series.SeriesCreateRequest;
import com.switchmanga.api.dto.series.SeriesUpdateRequest;
import com.switchmanga.api.entity.Publisher;
import com.switchmanga.api.entity.Series;
import com.switchmanga.api.entity.Series.SeriesStatus;
import com.switchmanga.api.entity.User;
import com.switchmanga.api.repository.PublisherRepository;
import com.switchmanga.api.repository.SeriesRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

/**
 * Publisher Service
 * Publisher Portal ê´€ë ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
 */
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class PublisherService {

    private final PublisherRepository publisherRepository;
    private final SeriesRepository seriesRepository;

    // ========================================
    // ğŸ“š Series ê´€ë¦¬
    // ========================================

    /**
     * ë‚´ Series ëª©ë¡ ì¡°íšŒ
     */
    public Map<String, Object> getMySeries(User user, int page, int size, String keyword, String status) {
        // Userì˜ Publisher ì°¾ê¸°
        Publisher publisher = getPublisherByUser(user);

        // Pageable ìƒì„±
        Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "createdAt"));

        // ê²€ìƒ‰ ì¡°ê±´ì— ë”°ë¼ ì¡°íšŒ
        Page<Series> seriesPage;

        if (keyword != null && !keyword.isEmpty() && status != null && !status.isEmpty()) {
            // í‚¤ì›Œë“œ + ìƒíƒœ
            seriesPage = seriesRepository.findByPublisherIdAndTitleContainingIgnoreCaseAndStatus(
                    publisher.getId(), keyword, SeriesStatus.valueOf(status), pageable
            );
        } else if (keyword != null && !keyword.isEmpty()) {
            // í‚¤ì›Œë“œë§Œ
            seriesPage = seriesRepository.findByPublisherIdAndTitleContainingIgnoreCase(
                    publisher.getId(), keyword, pageable
            );
        } else if (status != null && !status.isEmpty()) {
            // ìƒíƒœë§Œ
            seriesPage = seriesRepository.findByPublisherIdAndStatus(
                    publisher.getId(), SeriesStatus.valueOf(status), pageable
            );
        } else {
            // ì „ì²´
            seriesPage = seriesRepository.findByPublisherId(publisher.getId(), pageable);
        }

        // ê²°ê³¼ ë§¤í•‘
        Map<String, Object> result = new HashMap<>();
        result.put("content", seriesPage.getContent());
        result.put("page", seriesPage.getNumber());
        result.put("size", seriesPage.getSize());
        result.put("totalElements", seriesPage.getTotalElements());
        result.put("totalPages", seriesPage.getTotalPages());

        return result;
    }

    /**
     * ìƒˆ Series ìƒì„±
     */
    @Transactional
    public Series createSeries(User user, SeriesCreateRequest request, String coverImageUrl) {
        // Userì˜ Publisher ì°¾ê¸°
        Publisher publisher = getPublisherByUser(user);

        // Series ìƒì„±
        Series series = new Series();
        series.setPublisher(publisher);
        series.setTitle(request.getTitle());
        series.setTitleEn(request.getTitleEn());
        series.setTitleJp(request.getTitleJp());
        series.setAuthor(request.getAuthor());
        series.setArtist(request.getArtist());
        series.setDescription(request.getDescription());

        // StatusëŠ” Enumìœ¼ë¡œ ë³€í™˜
        series.setStatus(SeriesStatus.valueOf(request.getStatus()));

        series.setCoverImage(coverImageUrl);

        // ê°€ê²© ì •ë³´ - BigDecimalë¡œ ë³€í™˜
        series.setPricingModel(request.getPricingModel());
        series.setDefaultPrice(BigDecimal.valueOf(request.getDefaultPrice()));
        series.setRentalPrice(BigDecimal.valueOf(request.getRentalPrice()));
        series.setRentalDays(request.getRentalDays());
        series.setSubscriptionPrice(BigDecimal.valueOf(request.getSubscriptionPrice()));
        series.setFreeVolumes(request.getFreeVolumes());

        series.setActive(true);
        series.setCreatedAt(LocalDateTime.now());
        series.setUpdatedAt(LocalDateTime.now());

        return seriesRepository.save(series);
    }

    /**
     * Series ìƒì„¸ ì¡°íšŒ
     */
    public Series getMySeriesDetail(User user, Long seriesId) {
        // Userì˜ Publisher ì°¾ê¸°
        Publisher publisher = getPublisherByUser(user);

        // Series ì¡°íšŒ
        Series series = seriesRepository.findById(seriesId)
                .orElseThrow(() -> new RuntimeException("ì‹œë¦¬ì¦ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"));

        // ê¶Œí•œ í™•ì¸ (ë‚´ Publisherì˜ Seriesì¸ì§€)
        if (!series.getPublisher().getId().equals(publisher.getId())) {
            throw new RuntimeException("í•´ë‹¹ ì‹œë¦¬ì¦ˆì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤");
        }

        return series;
    }

    /**
     * Series ìˆ˜ì •
     */
    @Transactional
    public Series updateSeries(User user, Long seriesId, SeriesUpdateRequest request, String coverImageUrl) {
        // Series ì¡°íšŒ ë° ê¶Œí•œ í™•ì¸
        Series series = getMySeriesDetail(user, seriesId);

        // ìˆ˜ì • (nullì´ ì•„ë‹Œ ê°’ë§Œ)
        if (request.getTitle() != null) {
            series.setTitle(request.getTitle());
        }
        if (request.getTitleEn() != null) {
            series.setTitleEn(request.getTitleEn());
        }
        if (request.getTitleJp() != null) {
            series.setTitleJp(request.getTitleJp());
        }
        if (request.getAuthor() != null) {
            series.setAuthor(request.getAuthor());
        }
        if (request.getArtist() != null) {
            series.setArtist(request.getArtist());
        }
        if (request.getDescription() != null) {
            series.setDescription(request.getDescription());
        }
        if (request.getStatus() != null) {
            series.setStatus(SeriesStatus.valueOf(request.getStatus()));
        }
        if (coverImageUrl != null) {
            series.setCoverImage(coverImageUrl);
        }
        if (request.getPricingModel() != null) {
            series.setPricingModel(request.getPricingModel());
        }
        if (request.getDefaultPrice() != null) {
            series.setDefaultPrice(BigDecimal.valueOf(request.getDefaultPrice()));
        }
        if (request.getRentalPrice() != null) {
            series.setRentalPrice(BigDecimal.valueOf(request.getRentalPrice()));
        }
        if (request.getRentalDays() != null) {
            series.setRentalDays(request.getRentalDays());
        }
        if (request.getSubscriptionPrice() != null) {
            series.setSubscriptionPrice(BigDecimal.valueOf(request.getSubscriptionPrice()));
        }
        if (request.getFreeVolumes() != null) {
            series.setFreeVolumes(request.getFreeVolumes());
        }

        series.setUpdatedAt(LocalDateTime.now());

        return seriesRepository.save(series);
    }

    /**
     * Series ì‚­ì œ (Soft Delete)
     */
    @Transactional
    public void deleteSeries(User user, Long seriesId) {
        // Series ì¡°íšŒ ë° ê¶Œí•œ í™•ì¸
        Series series = getMySeriesDetail(user, seriesId);

        // Soft Delete
        series.setActive(false);
        series.setUpdatedAt(LocalDateTime.now());

        seriesRepository.save(series);
    }

    // ========================================
    // ğŸ› ï¸ Helper Methods
    // ========================================

    /**
     * Userë¡œë¶€í„° Publisher ì°¾ê¸°
     */
    private Publisher getPublisherByUser(User user) {
        // TODO: User-Publisher ì—°ê²° í…Œì´ë¸” êµ¬í˜„ í›„ ì‹¤ì œ ë¡œì§ìœ¼ë¡œ êµì²´
        // í˜„ì¬ëŠ” ì„ì‹œë¡œ user.getId()ë¡œ publisher ì°¾ê¸°

        return publisherRepository.findById(user.getId())
                .orElseThrow(() -> new RuntimeException("ì¶œíŒì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"));
    }
}